name: Actualizar Web de Entrenos

on:
  schedule:
    - cron: '0 13 * * *' # 08:00 AM Colombia
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Instalar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Instalar Librerías
        run: pip install pandas requests

      - name: Descargar Data y Crear Web
        env:
          API_KEY: ${{ secrets.INTERVALS_API_KEY }}
          ID: ${{ secrets.INTERVALS_ID }}
        run: |
          python -c "
          import requests
          import pandas as pd
          import os
          from datetime import datetime, timedelta

          # --- CONFIG ---
          api_key = os.environ['API_KEY']
          athlete_id = os.environ['ID']
          auth = ('API_KEY', api_key)
          
          # Fechas: Últimos 60 días
          oldest = (datetime.now() - timedelta(days=60)).strftime('%Y-%m-%d')
          newest = datetime.now().strftime('%Y-%m-%d')

          # 1. TRAER ACTIVIDADES
          url_act = f'https://intervals.icu/api/v1/athlete/{athlete_id}/activities?oldest={oldest}&newest={newest}'
          r_act = requests.get(url_act, auth=auth)
          df_act = pd.DataFrame(r_act.json()) if r_act.status_code == 200 else pd.DataFrame()

          # 2. TRAER WELLNESS
          url_well = f'https://intervals.icu/api/v1/athlete/{athlete_id}/wellness?oldest={oldest}&newest={newest}'
          r_well = requests.get(url_well, auth=auth)
          df_well = pd.DataFrame(r_well.json()) if r_well.status_code == 200 else pd.DataFrame()

          # 3. GENERAR PÁGINA WEB (HTML)
          # Unimos todo en un HTML simple que el bot SI puede leer
          html_content = f'''
          <html>
          <head><title>Entrenos Data</title></head>
          <body>
            <h1>Última Actualización: {newest}</h1>
            <h2>Biometría (Wellness)</h2>
            {df_well.to_html(index=False, border=1) if not df_well.empty else 'No data'}
            <br><hr><br>
            <h2>Entrenamientos (Activities)</h2>
            {df_act.to_html(index=False, border=1) if not df_act.empty else 'No data'}
          </body>
          </html>
          '''
          
          with open('index.html', 'w') as f:
              f.write(html_content)
          
          print('✅ Página Web generada correctamente.')
          "

      - name: Publicar cambios
        run: |
          git config --global user.name 'IntervalsBot'
          git config --global user.email 'bot@noreply.github.com'
          git add index.html
          git commit -m "Web Update: $(date +'%Y-%m-%d')" || exit 0
          git push
